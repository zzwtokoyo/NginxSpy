# NginxSpy 安装程序制作指南

## 📦 概述

是的，完全可以为NginxSpy制作专业的EXE安装程序包，并自动生成桌面快捷方式。本指南将介绍几种主流的安装程序制作方案。

## 🎯 推荐方案

### 方案一：Inno Setup（推荐）⭐

**优势：**
- 完全免费且开源
- 功能强大，支持现代安装程序特性
- 学习曲线相对平缓
- 社区活跃，文档丰富
- 支持自定义界面和脚本
- 可以创建桌面快捷方式、开始菜单项
- 支持自包含.NET应用程序

**适用场景：** 中小型应用程序，需要灵活定制的安装程序

### 方案二：WiX Toolset

**优势：**
- 微软官方支持
- 生成标准MSI安装包
- 企业级功能支持
- 与Visual Studio集成
- 支持复杂的安装逻辑

**劣势：**
- 学习曲线陡峭
- XML配置复杂
- 文档相对稀少

**适用场景：** 企业级应用程序，需要MSI格式的安装包

### 方案三：MSIX（现代化方案）

**优势：**
- 微软推荐的现代安装格式
- 支持自动更新
- 沙盒化安装
- 可通过Microsoft Store分发

**劣势：**
- 仅支持Windows 10 1709+
- 功能限制较多
- 不适合传统桌面应用

## 🚀 Inno Setup 实施指南

### 第一步：准备自包含发布版本

```bash
# 发布自包含的Windows x64版本
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true

# 或者发布框架依赖版本（需要用户安装.NET 8）
dotnet publish -c Release -r win-x64 --self-contained false
```

### 第二步：安装Inno Setup

1. 下载Inno Setup：https://jrsoftware.org/isinfo.php
2. 安装到系统（免费）
3. 启动Inno Setup Compiler

### 第三步：创建安装脚本

创建 `NginxSpy-Setup.iss` 文件：

```pascal
[Setup]
AppName=NginxSpy
AppVersion=1.0.0
AppPublisher=Your Company Name
AppPublisherURL=https://your-website.com
AppSupportURL=https://your-website.com/support
AppUpdatesURL=https://your-website.com/updates
DefaultDirName={autopf}\NginxSpy
DefaultGroupName=NginxSpy
AllowNoIcons=yes
LicenseFile=LICENSE.txt
OutputDir=installer
OutputBaseFilename=NginxSpy-Setup-v1.0.0
SetupIconFile=NginxSpy\Resources\app-icon.ico
Compression=lzma
SolidCompression=yes
WizardStyle=modern
PrivilegesRequired=lowest
ArchitecturesAllowed=x64
ArchitecturesInstallIn64BitMode=x64

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1

[Files]
; 主程序文件
Source: "NginxSpy\bin\Release\net8.0-windows\win-x64\publish\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
; 用户文档
Source: "用户使用手册.md"; DestDir: "{app}\docs"; Flags: ignoreversion
Source: "注意事项和最佳实践.md"; DestDir: "{app}\docs"; Flags: ignoreversion
Source: "README.md"; DestDir: "{app}\docs"; Flags: ignoreversion

[Icons]
; 开始菜单快捷方式
Name: "{group}\NginxSpy"; Filename: "{app}\NginxSpy.exe"; IconFilename: "{app}\NginxSpy.exe"
Name: "{group}\用户手册"; Filename: "{app}\docs\用户使用手册.md"
Name: "{group}\{cm:UninstallProgram,NginxSpy}"; Filename: "{uninstallexe}"
; 桌面快捷方式
Name: "{autodesktop}\NginxSpy"; Filename: "{app}\NginxSpy.exe"; Tasks: desktopicon; IconFilename: "{app}\NginxSpy.exe"
; 快速启动栏快捷方式
Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\NginxSpy"; Filename: "{app}\NginxSpy.exe"; Tasks: quicklaunchicon

[Run]
; 安装完成后运行程序
Filename: "{app}\NginxSpy.exe"; Description: "{cm:LaunchProgram,NginxSpy}"; Flags: nowait postinstall skipifsilent

[UninstallDelete]
; 清理用户数据（可选）
Type: filesandordirs; Name: "{userappdata}\NginxSpy"

[Code]
// 检查是否已安装.NET 8（如果使用框架依赖版本）
function IsDotNet8Installed(): Boolean;
var
  Success: Boolean;
  InstallPath: String;
begin
  Success := RegQueryStringValue(HKLM, 'SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedhost', 'Version', InstallPath);
  Result := Success and (CompareVersion(InstallPath, '8.0.0') >= 0);
end;

// 安装前检查
function InitializeSetup(): Boolean;
begin
  Result := True;
  // 如果使用框架依赖版本，取消注释以下代码
  (*
  if not IsDotNet8Installed() then
  begin
    MsgBox('此应用程序需要 .NET 8 运行时。请先安装 .NET 8 Desktop Runtime。', mbError, MB_OK);
    Result := False;
  end;
  *)
end;
```

### 第四步：编译安装程序

1. 在Inno Setup Compiler中打开 `NginxSpy-Setup.iss`
2. 点击 "Compile" 按钮
3. 生成的安装程序位于 `installer` 目录

## 🛠️ WiX Toolset 实施指南

### 安装WiX Toolset

```bash
# 安装WiX工具
dotnet tool install --global wix

# 或通过Visual Studio扩展安装
```

### 创建WiX项目

1. 在解决方案中添加新的WiX项目
2. 配置Product.wxs文件
3. 使用Heat工具生成文件清单
4. 编译生成MSI安装包

## 📋 自动化构建脚本

创建 `Build-Installer.ps1` 脚本：

```powershell
# NginxSpy 安装程序构建脚本

param(
    [string]$Version = "1.0.0",
    [string]$Configuration = "Release"
)

$ErrorActionPreference = "Stop"

Write-Host "开始构建 NginxSpy 安装程序..." -ForegroundColor Green

# 1. 清理输出目录
Write-Host "清理输出目录..." -ForegroundColor Yellow
if (Test-Path "installer") {
    Remove-Item "installer" -Recurse -Force
}
New-Item -ItemType Directory -Path "installer" -Force | Out-Null

# 2. 发布应用程序
Write-Host "发布自包含应用程序..." -ForegroundColor Yellow
dotnet publish NginxSpy\NginxSpy.csproj -c $Configuration -r win-x64 --self-contained true -p:PublishSingleFile=true -p:Version=$Version

if ($LASTEXITCODE -ne 0) {
    Write-Error "应用程序发布失败"
    exit 1
}

# 3. 检查Inno Setup
$InnoSetupPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
if (-not (Test-Path $InnoSetupPath)) {
    Write-Error "未找到 Inno Setup，请先安装 Inno Setup 6"
    exit 1
}

# 4. 编译安装程序
Write-Host "编译安装程序..." -ForegroundColor Yellow
& $InnoSetupPath "NginxSpy-Setup.iss" /DAppVersion=$Version

if ($LASTEXITCODE -ne 0) {
    Write-Error "安装程序编译失败"
    exit 1
}

Write-Host "安装程序构建完成！" -ForegroundColor Green
Write-Host "输出文件：installer\NginxSpy-Setup-v$Version.exe" -ForegroundColor Cyan
```

## 🎨 高级功能

### 自定义安装界面

- 添加自定义欢迎页面
- 集成许可协议
- 自定义安装选项
- 添加安装进度动画

### 自动更新支持

- 集成Squirrel.Windows
- 实现应用内更新检查
- 支持增量更新

### 数字签名

```bash
# 使用代码签名证书签名安装程序
signtool sign /f "certificate.pfx" /p "password" /t "http://timestamp.digicert.com" "NginxSpy-Setup.exe"
```

## 📊 方案对比

| 特性 | Inno Setup | WiX Toolset | MSIX |
|------|------------|-------------|------|
| 学习难度 | 简单 | 困难 | 中等 |
| 自定义程度 | 高 | 很高 | 低 |
| 文件大小 | 小 | 中等 | 大 |
| 系统兼容性 | 广泛 | 广泛 | 限制 |
| 企业部署 | 支持 | 优秀 | 优秀 |
| 开发成本 | 低 | 高 | 中等 |

## 🔧 故障排除

### 常见问题

1. **权限问题**：使用 `PrivilegesRequired=lowest` 避免需要管理员权限
2. **文件路径**：确保所有文件路径正确，使用相对路径
3. **图标显示**：确保ICO文件格式正确，包含多种尺寸
4. **卸载清理**：正确配置卸载时的文件清理

### 调试技巧

- 使用Inno Setup的调试模式
- 检查安装日志文件
- 测试不同Windows版本的兼容性

## 📝 总结

推荐使用 **Inno Setup** 作为NginxSpy的安装程序制作工具，因为它：

✅ 完全免费且功能强大  
✅ 学习成本低，文档丰富  
✅ 支持现代安装程序特性  
✅ 可以轻松创建桌面快捷方式  
✅ 支持自包含.NET应用程序  
✅ 生成的安装程序体积小且兼容性好  

按照本指南的步骤，您可以为NginxSpy创建专业的Windows安装程序，提供良好的用户安装体验。